<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="../css/lessons.css">
    <title>Student Dashboard</title>
</head>
<body>
    <div class="content">
        <div class="accountcontrol" id="accountcontrol" onclick="endAccountControlSession()">
        </div>
        <div class="center" id="center">
            <img src="" alt="" id="userProfile">
            <input type="file" accept="image/png, image/jpeg" id="choosefile" hidden>
            <label for="choosefile" id="pictureChanger">CHANGE PROFILE PICTURE</label>
            <small>ENROLLED PROGRAMS</small>
            <div class="enrollmentCLASSES" id="enrollmentCLASSES">
            </div>
          </div>
        <div class="loader" id="loader">
            <div class="lc">
                <img src="../assets/images/loading.gif" alt="">
            <h2>Loading ...</h2>
            </div>
        </div>
        <div class="col1">
            <img src="../assets/images/logo.png" alt="" class="logo">
            <div class="navGroup">
                <img src="../assets/images/home.png" alt="">
                <h2 class="clickItem" onclick="switchTabFor(0)">Home</h2>
            </div>
            <div class="navGroup">
                <img src="../assets/images/help.png" alt="">
                <h2 class="clickItem" onclick="switchTabFor(1)">Help</h2>
            </div>
            <div class="out">
                <img src="../assets/images/out.png" alt="">
                <h2 onclick="logout()">Logout</h2>
            </div>
            <div class="out" onclick="startAccountControlSession()">
                <img src="../assets/images/account.png" alt="">
                <h2>Account</h2>
            </div>


        </div>
        <div class="mainNavigator">
            <div class="col2" id="home">
                <div class="row1">
                    <img src="" alt="" id="userprofilepicture" onclick="startAccountControlSession()">
                    <h1>Home</h1>

                </div>
                <div class="row2">
                    
                    <div class="card" id="enrolledPrograms">
                        <small>ENROLLED PROGRAMS</small>
                        
                    </div>
                    <div class="card" id="nothing">
                        <img src="../assets/images/empty.png" alt="">
                        <h2>Nothing to Show</h2>
                       
                    </div>
                    <div class="card" id="programstoEnrlss">
                        <small>AVAILABLE PROGRAMS</small>
                        <div class="rectangle">
                            <h3>AEC360 Business</h3>
                            <p>A business is defined as an organization or enterprising entity engaged in commercial, industrial, or professional activities. Businesses can be for-profit entities or they can be non-profit organizations that operate to fulfill a charitable </p>
                            <button onclick="enroll(`AEC360 Business`)">Enroll</button>
                        </div>       
                        <div class="rectangle">
                            <h3>AEC360 Professional</h3>
                            <p>A business is defined as an organization or enterprising entity engaged in commercial, industrial, or professional activities. Businesses can be for-profit entities or they can be non-profit organizations that operate to fulfill a charitable </p>
                            <button onclick="enroll(`AEC360 Professional`)">Enroll</button>
                        </div> 
                        <div class="rectangle">
                            <h3>AEC360 Executive
                            </h3>
                            <p>A business is defined as an organization or enterprising entity engaged in commercial, industrial, or professional activities. Businesses can be for-profit entities or they can be non-profit organizations that operate to fulfill a charitable </p>
                            <button onclick="enroll(`AEC360 Executive`)">Enroll</button>
                        </div> 
                        <div class="rectangle">
                            <h3>AEC360 Custom
                            </h3>
                            <p>A business is defined as an organization or enterprising entity engaged in commercial, industrial, or professional activities. Businesses can be for-profit entities or they can be non-profit organizations that operate to fulfill a charitable </p>
                            <button onclick="enroll(`AEC360 Custom`)">Enroll</button>
                        </div> 
                    </div>
                    
                </div>
            </div>
            <div class="col2" id="helpfiles">
                <div class="row1">
                    <h1>Help Files</h1>

                </div>
                      <div class="row2">
                        <div class="rectangle">
                            <div class="r1">
                                <img src="../assets/images/gettingStarted.png" alt="">
                                <h2>Getting Started</h2>
                            </div>
                            <p>Main information aboutn the programs</p>
                            <button>Get Started</button>    

                        </div>       
                        <div class="rectangle">
                            <div class="r1">
                                <img src="../assets/images/faqs.png" alt="">

                                <div class="m">
                                    <h2>Other help and FAQS</h2>
                                <p>Main information aboutn the programs</p>
                                <button>View FAQs</button>    
                                </div>
                            </div>
                        </div>
                      </div>
            </div>
        </div>
    </div>
        <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.1.1/firebase.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-analytics.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
          apiKey: "AIzaSyDV8mW8bweN6YOg0OKgRZ9umOVs_UUN-pA",
          authDomain: "primecs-1cbfc.firebaseapp.com",
          projectId: "primecs-1cbfc",
          storageBucket: "primecs-1cbfc.appspot.com",
          messagingSenderId: "33832366036",
          appId: "1:33832366036:web:cc0d5c26b3c1b4690ff041",
          measurementId: "G-ETGHB4KYQF"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        var db = firebase.firestore();
        var userId;
        var courserBeingTaken;
        var globalUserId;
        var choosefile = document.getElementById("choosefile").onchange = function(){
            var storageRef = firebase.storage().ref();
            var userStorageRef = storageRef.child(String(userId));

            const selectedFile = document.getElementById('choosefile').files[0];
            document.getElementById("loader").style.display = "block";
            userStorageRef.put(selectedFile).then(function(snapshot) {
                endAccountControlSession();
                
                const fileDirectory = snapshot.ref.getDownloadURL().then(url=>{
                    console.log(url);
                    populateUserImages();
                    document.getElementById("loader").style.display = "none";
                }).catch(error=>{
                    alert(error);
                    console.log(error);
                })
            }).catch(error=>{
                alert(String(error));
                console.log(error);
            });

        };


        switchTabFor(0);
        loadUserClasses();
        populateUserImages();

        function loadUserClasses() {
            var enrolledPrograms = document.getElementById("enrolledPrograms");
            var cookies = document.cookie
                .split(';')
                .map(cookie => cookie.split('='))
                .reduce((accumulator, [key, value]) => ({
                    ...accumulator,
                    [key.trim()]: decodeURIComponent(value)
                }), {});

            console.log(`Starting retrieving`);
            console.log(cookies);

            userId = String(cookies.nick);
            var uidLength = userId.split(``).length;

            document.cookie = "nick=; expires=Thu, 01 Jan 1970 00:00:00 UTC;";

            if ((userId == "undefined") && (globalUserId == "")) {
                location.href = 'signinup.html';

            } else {
                globalUserId = userId;
                try {
                    document.getElementById("loader").style.display = "block";
                    db.collection('users').doc(userId).get().then((data) => {
                        document.getElementById("loader").style.display = "none";
                        courserBeingTaken = data.data().courses.trim().split(` `);
                        console.log(courserBeingTaken);

                        if ((courserBeingTaken.length !== 0)) {
                            for (let course of courserBeingTaken) {

                                if (course != "") {
                                enrolledPrograms.innerHTML += `
                                <div class="rectangle">
                                <h3>${course}</h3>
                                <p>${fetchContent(String(course))}</p>
                                <button onclick="createCookie(${uidLength})">Continue</button>
                                <button onclick="exitClass('${course}')">Exit Course</button>
                                </div>
                                `;
                                document.getElementById("enrollmentCLASSES").innerHTML+=`

                                <div class="enrollmentClass">
                                <p>${course}</p>
                                </div>
                                `
                                }

                            }
                        }

                        if (courserBeingTaken.length !== 0) {
                            document.getElementById("nothing").style.display = "none";
                        }

                    }).catch(err => {
                        alert(err+"Line 239");
                    })
                } catch (err) {
                    alert(err);
                    console.log(err);
                }
            }
            document.cookie = "_hush="+userId;
        }

        function createCookie(uidLength) {
            document.cookie = `notallowed=` + String(uidLength == 0);
            location.href = `aec360p.html`;
            console.log(document.cookie);
            console.log(`Called`);
        }

        function enroll(newClass) {
            var stringCourse = "";
            var isEnrolled = false;
            console.log(courserBeingTaken);
            for (let course of courserBeingTaken) {
                stringCourse += course + " ";
                if (course == String(newClass).replaceAll(` `, `_`)) {
                    isEnrolled = true;
                }
            }
            console.log(stringCourse);
            stringCourse += String(newClass).replaceAll(` `, `_`);
            if (!isEnrolled) {
                document.getElementById("loader").style.display = "block";
                db.collection('users').doc(userId).set({
                    courses: stringCourse
                }).then(() => {
                    document.getElementById("loader").style.display = "none";
                    document.cookie = "nick="+userId;    
            location.href = `lessons.html`;
                });
            } else {
                alert(`Already Enrolled`);
            }
            //loadUserClassesWithParam(userId); 
        }

        function fetchContent(subject) {
            var descriptionObject = {
                AEC360_Business: "A company, abbreviated as co., is a legal entity representing an association of people, whether natural, legal or a mixture of both, with a specific objective. ",
                AEC360_Custom: " It is the custom to give gifts at Christmas time. Habit, applied particularly to an individual, implies such repetition of the same action as to develop a natural, spontaneous, or rooted tendency or inclination to perform it: to make a habit of reading the newspapers. Practice applies to a set of fixed habits or an ordered procedure in conducting activities: It is his practice to verify all statements.",
                AEC360_Executive: "The executive is the branch of government exercising authority in and holding responsibility for the governance of a state. The executive executes and enforces law.",
                AEC360_Professional: "A profession is an occupation founded upon specialized educational training, the purpose of which is to supply disinterested objective counsel and service to others, for a direct and definite compensation, wholly apart from expectation of other business gain.",
            }
            return descriptionObject[subject];
        }

        //FUNCTION TO RELOAD DATA FROM DATABASE AFTER ENROLLMENT
        //IT SHOULD ALSO HAVE TO MANIPULATE VIEWS AS THE FIRST FUNCTION
        function loadUserClassesWithParam(PARAM_USERID) {
            var enrolledPrograms = document.getElementById("enrolledPrograms");
            enrolledPrograms.innerHTML = "<small>ENROLLED PROGRAMS</small>";
            try {
                db.collection('users').doc(PARAM_USERID).get().then((data) => {
                    console.log(data.data());
                    courserBeingTaken = data.data().courses.split(` `);
                    console.log(courserBeingTaken);
                    if ((courserBeingTaken.length !== 0)) {
                        for (let course of courserBeingTaken) {
                            if (course != "") {
                                enrolledPrograms.innerHTML += `
                                <div class="rectangle">
                                <h3>${course}</h3>
                                <p>${fetchContent(String(course))}</p>
                                <button onclick="createCookie(${uidLength})">Continue</button>
                                <button onclick="exitClass('${course}')">Exit Course</button>
                                </div>
                                `;
                            }
                        }
                    }
                    if (courserBeingTaken.length !== 0) {
                        document.getElementById("nothing").style.display = "none";
                    }
                }).catch(err => {
                    alert(err);
                    console.log(err);
                })
            } catch (err) {

            }
            document.cookie = "_hush="+userId;
        }

        function switchTabFor(NUMBER){
            var tabs = document.getElementsByClassName("col2");
            var navigators = document.getElementsByClassName("clickItem");
            for(let tab of tabs){
                tab.style.display = "none";
            }
            for(let navigator of navigators){
                navigator.style.color = "#EAEDE6";
            }
            tabs[NUMBER].style.display = "block";
            navigators[NUMBER].style.color = "#8FE423";
        }
        function logout(){
            firebase.auth().signOut().then(()=>{
                location.href = `signinup.html`;
            }).catch(err=>{

            })
        }

        function startAccountControlSession(){
            var parent = document.getElementById("accountcontrol");
            var child = document.getElementById("center");

            parent.style.display = "block";
            child.style.display = "flex";

        }
        function endAccountControlSession(){
            var parent = document.getElementById("accountcontrol");
            var child = document.getElementById("center");

            parent.style.display = "none";
            child.style.display = "none";

        }
        function populateUserImages(){
            firebase.storage().ref().child(String(userId)).getDownloadURL().then((url)=>{
                document.getElementById("userprofilepicture").style.backgroundImage = `url(${url})`;
                document.getElementById("userProfile").style.backgroundImage = `url(${url})`;
            }).catch(error=>{

            })
        }


        function exitClass(newClass) {
            var stringCourse = "";
            console.log(stringCourse);
            for( var i = 0; i < courserBeingTaken.length; i++){ 
                    if ( courserBeingTaken[i] === String(newClass)) { 
                        courserBeingTaken.splice(i, 1); 
                    }
            }
            
            for (let course of courserBeingTaken) {
                stringCourse += course + " ";
            }
            document.getElementById("loader").style.display = "block";
            db.collection('users').doc(userId).set({
            courses: stringCourse
            }).then(() => {
            document.getElementById("loader").style.display = "none";
            document.cookie = "nick="+userId;    
            location.href = `lessons.html`;
            });
            
        }




         </script>
</body>
</html>